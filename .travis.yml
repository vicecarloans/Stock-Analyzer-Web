sudo: required
services:
  - docker
stages:
  - Build
  - name: Deploy
    if: branch = deployment OR branch = develop AND type IN (push)
addons:
  sshknownhosts:
    - 178.128.231.244
branches:
  only:
    - develop
env:
  global:
    - REGISTRY_USER=stockanalyzerautomation
    - REMOTEUSER=root
    - REMOTEHOST=178.128.231.244
    - PORT=3000
before_script:
  - docker pull coincard/stock-analyzer-web || true
script:
  - docker build --pull --cache-from coincard/stock-analyzer-web --tag coincard/stock-analyzer-web
    .
  - docker run coincard/stock-analyzer-web
after_script:
  - docker images
before_deploy:
  - docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"
deploy:
  matrix:
    - provider: script
      script:
        - docker push coincard/stock-analyzer-web
        - ssh -i
      on:
        branch: deployment
    - provider: heroku
      api_key:
        secure: iaTwmgoZIcYI7pfvx9OPIQ5rBzROEIJE2Wh+vTuWNBzOx1zYkOFDJbPGfzwWmnD4urKATYJzpioJua2aRhApxa3DrwwSLxdtx6PnhoznjstxKxq5UCaaC55WuhcWJVrIJVuIAh8j+mdkSDPwoc5HmrOOVwSdsrdqUhoNHE/jZJN5Cx1DMef+2ZRdnHanVq3TAAkf9XvVCwH67E5D8QXu9m/120LI2PnO3BGx3ImTqGOKAKjGzP0flr358vPgzyKj67YqaloZ7Ev2y4z5W0/BsoJEYXh6HICMGnmAN5g82lEricmIMaP/R0CiFxYVez/UXgUDZD27MrRMch/A4Pox4hAqZgYtgc7B+p2urLQI9Ma+D9KpLOGMWazqrgzpmNBYDqLftToOPVmt0HQr8NIf705wYd0SOyPWZP3abH0wMLuSpWmm+dIc9ln9JiB/ZCHbyXSTjaKTk0rqydqi/xBgPVDjIFF3GUmeWyyZ3muhQEZb1GLntCPoa/njKNxdAqhFv1gigKYFVieaQk0DuXXFKuI7ctEdKk+NoJhJ/bmsDv/9GV9Q3SMMpMDS1FZOHJ2accAOjmv/J4ObDHZsKsMeb1O9fdc2yT6frukQB5+iby6kQo9QI9f54nbh0+u2rtvWvaZ0LWyY6BP9CpGYxyd+uI4btGdiXz20Yq12Wdsv/y0=
      app: stock-analyzer-huydam
      on:
        branch: develop
  notifications:
  slack:
    secure: hBKC+4DKooWgJiT4A9gJABTPtlnxEvCdROn/eN/MfVbD+9MQcIoh0scOUFq6AyMOdcaxx4fjnBUFqCgL1Lr+4uxXVJxII+BCJaObrnlw+Xnf+LRaeovUCl769joN2y4l05clRLEpDG6Rq4XG3mCvL34M/ti/WWnARRvnSngEy0p6yH7N9FDHoR+5Rgjz5VP+ZoPJAiFrfZM2zAUV3WAVllkq8W23+UsiXlH5bDNMYh/2sM4xxWmKjKTF8HwErQKbngh07H4apyLoVS9PLZv6sYr4v/xt4rCyXByA1ArjXqQUK4spYX5X4xkl2n1yHz/lria/ReCCURYCcX+VAIDq8AZNwS3sREyF3yqUwoTlL6Tsfdrg+7fvXMHOi6WGZvhENa+Y1Oze/Iv09Bx3ux2e8KlAqF/bTnemXhP2H4EZ8/YMj7vQtyr+s4XzbAqfL+j6B7V6pRM1UkX83v7wsi9qV8AV4WpT1V38R6C23zlxUAgFVCIDY/fHRMzvex1Z0BSR0UxHvDludmnKV3tb76OCcPhlXB7cmjZLE3LQL14oA9BA5Uxlu5ful5QHHERk9TfxTpikclUc2tuFFlWTbTw4ZCkEU/k9Z0wvfOcKePNFfK8R/CgXBShwes8pOtryn+KBtnIZP/HywRldMnmdlTcZfGtA3LFfsJTHQPTSIQvyn4M=
before_install:
  - openssl aes-256-cbc -K $encrypted_922def39450f_key -iv $encrypted_922def39450f_iv
    -in deploy.enc -out deploy -d
